<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>فروشگاه من</title>
    
    <link rel="stylesheet" href="style.css" id="css-link">
    <link rel="manifest" href="manifest.json" id="manifest-link">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
</head>
<body>

    <div class="version-display"></div>

    <main>
        <!-- The "shop" section is now active by default -->
        <section id="shop" class="content-section active">
            <div id="category-grid-view">
                <h1>دسته‌بندی محصولات</h1>
                <div class="category-grid">
                    <a href="#products" class="category-card" data-category="پاسارگاد سیکلت فارس (آشیل)">پاسارگاد سیکلت فارس (آشیل)</a>
                    <a href="#products" class="category-card" data-category="سهند سیکلت (هرم اسپید)">سهند سیکلت (هرم اسپید)</a>
                    <a href="#products" class="category-card" data-category="ایران دوچرخ">ایران دوچرخ</a>
                    <a href="#products" class="category-card" data-category="سپاهان سیکلت">سپاهان سیکلت</a>
                    <a href="#products" class="category-card" data-category="کلیک و های کلیک">کلیک و های کلیک</a>
                    <a href="#products" class="category-card" data-category="قطعات ویو و طرح ویو">قطعات ویو و طرح ویو</a>
                    <a href="#products" class="category-card" data-category="آیروکس و NVX۱۵۵">آیروکس و NVX۱۵۵</a>
                    <a href="#products" class="category-card" data-category="طرح ADV">طرح ADV</a>
                    <a href="#products" class="category-card" data-category="باکسر ۱۵۰">باکسر ۱۵۰</a>
                    <a href="#products" class="category-card" data-category="کلاه و تجهیزات ایمنی">کلاه و تجهیزات ایمنی</a>
                </div>
            </div>
            <div id="product-list-view" style="display: none;">
                <button id="back-to-categories" class="back-button">&larr; بازگشت به دسته‌بندی‌ها</button>
                <h2 id="product-list-title"></h2>
                <div class="product-list">
                    <p>محصولات این دسته در اینجا نمایش داده خواهند شد.</p>
                </div>
            </div>
        </section>

        <!-- NEW: "Orders" section with tabs -->
        <section id="orders" class="content-section">
            <h1>سفارش‌ها</h1>
            <div class="tabs-container">
                <div class="tab-buttons">
                    <button class="tab-button active" data-tab="open-orders">سفارش های باز</button>
                    <button class="tab-button" data-tab="past-orders">سفارش های گذشته</button>
                </div>
                <div id="open-orders" class="tab-content active">
                    <p>لیست سفارش‌های باز شما در اینجا نمایش داده خواهد شد.</p>
                </div>
                <div id="past-orders" class="tab-content">
                    <p>لیست سفارش‌های تکمیل شده شما در اینجا خواهد بود.</p>
                </div>
            </div>
        </section>

        <!-- NEW: "Chat & Contact" section with chat UI and phone link -->
        <section id="chat" class="content-section">
            <h1>چت و تماس</h1>
            <div class="chat-container">
                <div class="chat-messages">
                    <div class="message received">سلام! چطور میتونم کمکتون کنم؟</div>
                </div>
                <div class="chat-input-area">
                    <input type="text" placeholder="پیام خود را بنویسید...">
                    <button><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
            <div class="contact-info">
                <p>برای تماس مستقیم، روی شماره زیر کلیک کنید:</p>
                <a href="tel:+989123456789">۰۹۱۲-۳۴۵-۶۷۸۹</a>
            </div>
        </section>

        <!-- The "profile" section is no longer active by default -->
        <section id="profile" class="content-section">
            <!-- All profile content is preserved exactly as you had it -->
            <div id="login-view">
                <h1>ورود به حساب کاربری</h1>
                <form class="login-form" id="login-form">
                    <div class="form-group">
                        <label for="mobile">شماره موبایل</label>
                        <input type="tel" id="mobile" placeholder="مثال: 09123456789">
                    </div>
                    <div class="form-group">
                        <label for="password">رمز عبور</label>
                        <input type="password" id="password" placeholder="رمز عبور خود را وارد کنید">
                    </div>
                    <button type="submit" class="login-button">ورود</button>
                </form>
            </div>
            <div id="user-view" style="display: none;">
                <h1>پروفایل شما</h1>
                <p id="user-email"></p>
                <button id="logout-button" class="login-button">خروج از حساب</button>
            </div>
            <div id="admin-panel" style="display: none; margin-top: 30px; border-top: 2px solid #007bff; padding-top: 20px;">
                <h2>پنل مدیریت</h2>
                <form class="login-form" id="create-user-form">
                    <h3>ایجاد کاربر جدید</h3>
                    <div class="form-group">
                        <label for="new-mobile">شماره موبایل کاربر جدید</label>
                        <input type="tel" id="new-mobile" placeholder="مثال: 09351234567" required>
                    </div>
                    <div class="form-group">
                        <label for="new-password">رمز عبور کاربر جدید</label>
                        <input type="password" id="new-password" placeholder="حداقل ۶ کاراکتر" required>
                    </div>
                    <button type="submit" class="login-button">ایجاد کاربر</button>
                </form>
            </div>
        </section>
    </main>

    <nav class="bottom-nav">
        <!-- The "shop" button is now active by default -->
        <a href="#shop" class="nav-item active" data-page="shop"><i class="fas fa-store"></i><span>فروشگاه</span></a>
        <a href="#orders" class="nav-item" data-page="orders"><i class="fas fa-receipt"></i><span>سفارش‌ها</span></a>
        <a href="#chat" class="nav-item" data-page="chat"><i class="fas fa-comments"></i><span>چت و تماس</span></a>
        <!-- The "profile" button is no longer active -->
        <a href="#profile" class="nav-item" data-page="profile"><i class="fas fa-user"></i><span>پروفایل</span></a>
    </nav>

    <!-- Firebase SDK Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <!-- The One, Complete App Script -->
    <script>
        const appVersion = '2.0'; // Major update!
        const fakeDomain = '@myapp.com';

        // Your Firebase config, preserved from your file
        const firebaseConfig = {
          apiKey: "AIzaSyDC_sR04GqMolGCZuBqmshwMn3aP_1qxM8",
          authDomain: "my-pwa-shop-8e911.firebaseapp.com",
          projectId: "my-pwa-shop-8e911",
          storageBucket: "my-pwa-shop-8e911.appspot.com",
          messagingSenderId: "192952139085",
          appId: "1:192952139085:web:cd301112a862ab04d44b04"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- SECTION 1: INITIALIZATION & VERSIONING ---
        (function() {
            document.querySelector('.version-display').textContent = `v${appVersion}`;
            document.getElementById('css-link').href = `style.css?v=${appVersion}`;
            document.getElementById('manifest-link').href = `manifest.json?v=${appVersion}`;
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register(`./sw.js?v=${appVersion}`).then(reg => console.log('SW Registered')).catch(err => console.log('SW Error'));
                });
            }
        })();

        // --- SECTION 2: GET ELEMENT REFERENCES ---
        const contentSections = document.querySelectorAll('.content-section');
        const navItems = document.querySelectorAll('.nav-item');
        const loginForm = document.getElementById('login-form');
        const userView = document.getElementById('user-view');
        const adminPanel = document.getElementById('admin-panel');
        const categoryGridView = document.getElementById('category-grid-view');
        const productListView = document.getElementById('product-list-view');
        const productListTitle = document.getElementById('product-list-title');
        const backToCategoriesButton = document.getElementById('back-to-categories');
        const categoryCards = document.querySelectorAll('.category-card');
        const tabButtons = document.querySelectorAll('.tab-button');

        // --- SECTION 3: CORE NAVIGATION LOGIC ---

        navItems.forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const targetPage = item.getAttribute('data-page');

                history.pushState({ page: targetPage }, '', `#${targetPage}`);
                
                navItems.forEach(nav => nav.classList.remove('active'));
                item.classList.add('active');

                contentSections.forEach(section => {
                    section.classList.toggle('active', section.id === targetPage);
                });
            });
        });
        
        // History management for Shop page back button
        function showCategories() {
            productListView.style.display = 'none';
            categoryGridView.style.display = 'block';
        }

        function showProducts(categoryName) {
            productListTitle.textContent = categoryName;
            categoryGridView.style.display = 'none';
            productListView.style.display = 'block';
        }

        categoryCards.forEach(card => {
            card.addEventListener('click', (e) => {
                e.preventDefault();
                const categoryName = card.dataset.category;
                history.pushState({ page: 'products', category: categoryName }, categoryName, '#products');
                showProducts(categoryName);
            });
        });
        
        backToCategoriesButton.addEventListener('click', () => {
            history.back();
        });

        window.addEventListener('popstate', (event) => {
            if (event.state) {
                if (event.state.page === 'products') {
                    showProducts(event.state.category);
                } else {
                    // This handles back button for main pages
                    document.querySelector(`.nav-item[data-page="${event.state.page}"]`)?.click();
                    showCategories(); // Ensure shop is reset to category view
                }
            } else {
                // Fallback for initial state
                document.querySelector('.nav-item[data-page="shop"]')?.click();
                showCategories();
            }
        });

        // --- SECTION 4: OTHER EVENT LISTENERS ---

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const targetTab = button.dataset.tab;
                button.parentElement.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                button.closest('.tabs-container').querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                button.classList.add('active');
                document.getElementById(targetTab).classList.add('active');
            });
        });

        const logoutButton = document.getElementById('logout-button');
        const createUserForm = document.getElementById('create-user-form');
        
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const phoneNumber = loginForm.mobile.value;
            const password = loginForm.password.value;
            const email = phoneNumber.includes('@') ? phoneNumber : phoneNumber + fakeDomain;
            auth.signInWithEmailAndPassword(email, password).catch(error => alert(`خطا در ورود: ${error.message}`));
        });

        logoutButton.addEventListener('click', () => {
            auth.signOut();
        });

        createUserForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const phoneNumber = createUserForm['new-mobile'].value;
            alert(`آماده برای ایجاد کاربر با شماره: ${phoneNumber}. قابلیت اصلی در مرحله بعد اضافه خواهد شد.`);
            createUserForm.reset();
        });
        
        // --- SECTION 5: FIREBASE AUTH LOGIC ---
        auth.onAuthStateChanged(user => {
            const userEmailDisplay = document.getElementById('user-email');
            const loginView = document.getElementById('login-view');
            
            userView.style.display = 'none';
            adminPanel.style.display = 'none';
            loginView.style.display = 'block';

            if (user) {
                loginView.style.display = 'none';
                userView.style.display = 'block';
                userEmailDisplay.textContent = `خوش آمدید، ${user.email.replace(fakeDomain, '')}`;

                const userDocRef = db.collection('users').doc(user.uid);
                userDocRef.get().then((doc) => {
                    if (doc.exists && doc.data().role === 'admin') {
                        adminPanel.style.display = 'block';
                    }
                });
            }
        });
    </script>
</body>
</html>