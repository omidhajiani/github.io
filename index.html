<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>فروشگاه من</title>
    
    <link rel="stylesheet" href="style.css" id="css-link">
    <link rel="manifest" href="manifest.json" id="manifest-link">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
</head>
<body>

    <div class="version-display"></div>

    <main>
        <section id="shop" class="content-section active">
            <!-- Shop Content is Preserved -->
            <div id="category-grid-view">
                <h1>دسته‌بندی محصولات</h1>
                <div class="category-grid">
                    <a href="#products" class="category-card" data-category="پاسارگاد سیکلت فارس (آشیل)">پاسارگاد سیکلت فارس (آشیل)</a>
                    <a href="#products" class="category-card" data-category="سهند سیکلت (هرم اسپید)">سهند سیکلت (هرم اسپید)</a>
                    <a href="#products" class="category-card" data-category="ایران دوچرخ">ایران دوچرخ</a>
                    <a href="#products" class="category-card" data-category="سپاهان سیکلت">سپاهان سیکلت</a>
                    <a href="#products" class="category-card" data-category="کلیک و های کلیک">کلیک و های کلیک</a>
                    <a href="#products" class="category-card" data-category="قطعات ویو و طرح ویو">قطعات ویو و طرح ویو</a>
                    <a href="#products" class="category-card" data-category="آیروکس و NVX۱۵۵">آیروکس و NVX۱۵۵</a>
                    <a href="#products" class="category-card" data-category="طرح ADV">طرح ADV</a>
                    <a href="#products" class="category-card" data-category="باکسر ۱۵۰">باکسر ۱۵۰</a>
                    <a href="#products" class="category-card" data-category="کلاه و تجهیزات ایمنی">کلاه و تجهیزات ایمنی</a>
                </div>
            </div>
            <div id="product-list-view" style="display: none;">
                <button id="back-to-categories" class="back-button">&larr; بازگشت به دسته‌بندی‌ها</button>
                <h2 id="product-list-title"></h2>
                <div class="product-list">
                    <p>محصولات این دسته در اینجا نمایش داده خواهند شد.</p>
                </div>
            </div>
        </section>

        <section id="orders" class="content-section">
            <!-- Orders Content is Preserved -->
            <h1>سفارش‌ها</h1>
            <div class="tabs-container">
                <div class="tab-buttons">
                    <button class="tab-button active" data-tab="open-orders">سفارش های باز</button>
                    <button class="tab-button" data-tab="past-orders">سفارش های گذشته</button>
                </div>
                <div id="open-orders" class="tab-content active">
                    <p>لیست سفارش‌های باز شما در اینجا نمایش داده خواهد شد.</p>
                </div>
                <div id="past-orders" class="tab-content">
                    <p>لیست سفارش‌های تکمیل شده شما در اینجا خواهد بود.</p>
                </div>
            </div>
        </section>

        <!-- Chat Section is Updated -->
        <section id="chat" class="content-section">
            <h1>چت و تماس</h1>

            <!-- NEW: View for logged-out users -->
            <div id="logged-out-chat-view">
                <p class="chat-login-prompt">برای شروع چت، لطفا وارد حساب کاربری خود شوید.</p>
                <div class="chat-container disabled">
                    <div class="chat-messages">
                        <div class="message received">سلام! چطور میتونم کمکتون کنم؟</div>
                    </div>
                    <div class="chat-input-area">
                        <input type="text" placeholder="برای ارسال پیام وارد شوید" disabled>
                        <button disabled><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>

            <!-- View for regular users (hidden by default) -->
            <div id="user-chat-view" style="display: none;">
                <div class="chat-container">
                    <div class="chat-messages" id="user-chat-messages"></div>
                    <form class="chat-input-area" id="user-chat-form">
                        <input type="text" placeholder="پیام خود را بنویسید..." required>
                        <button type="submit"><i class="fas fa-paper-plane"></i></button>
                    </form>
                </div>
            </div>

            <!-- View for admins (hidden by default) -->
            <div id="admin-chat-view" style="display: none;">
                <!-- Admin Chat Layout is unchanged -->
            </div>

            <div class="contact-info">
                <!-- Contact Info is unchanged -->
            </div>
        </section>

        <section id="profile" class="content-section">
            <!-- Profile Content is Preserved -->
            <div id="login-view">
                <h1>ورود به حساب کاربری</h1>
                <form class="login-form" id="login-form">
                    <div class="form-group"><label for="mobile">شماره موبایل</label><input type="tel" id="mobile" placeholder="مثال: 09123456789"></div>
                    <div class="form-group"><label for="password">رمز عبور</label><input type="password" id="password" placeholder="رمز عبور خود را وارد کنید"></div>
                    <button type="submit" class="login-button">ورود</button>
                </form>
            </div>
            <div id="user-view" style="display: none;">
                <h1>پروفایل شما</h1>
                <p id="user-email"></p>
                <button id="logout-button" class="login-button">خروج از حساب</button>
            </div>
            <div id="admin-panel" style="display: none; margin-top: 30px; border-top: 2px solid #007bff; padding-top: 20px;">
                <h2>پنل مدیریت</h2>
                <form class="login-form" id="create-user-form">
                    <h3>ایجاد کاربر جدید</h3>
                    <div class="form-group"><label for="new-mobile">شماره موبایل کاربر جدید</label><input type="tel" id="new-mobile" placeholder="مثال: 09351234567" required></div>
                    <div class="form-group"><label for="new-password">رمز عبور کاربر جدید</label><input type="password" id="new-password" placeholder="حداقل ۶ کاراکتر" required></div>
                    <button type="submit" class="login-button">ایجاد کاربر</button>
                </form>
            </div>
        </section>
    </main>

    <nav class="bottom-nav">
        <!-- Navigation is Preserved -->
        <a href="#shop" class="nav-item active" data-page="shop"><i class="fas fa-store"></i><span>فروشگاه</span></a>
        <a href="#orders" class="nav-item" data-page="orders"><i class="fas fa-receipt"></i><span>سفارش‌ها</span></a>
        <a href="#chat" class="nav-item" data-page="chat"><i class="fas fa-comments"></i><span>چت و تماس</span></a>
        <a href="#profile" class="nav-item" data-page="profile"><i class="fas fa-user"></i><span>پروفایل</span></a>
    </nav>

    <!-- Firebase SDK Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <!-- The One, Complete, and Corrected App Script -->
    <script>
        const appVersion = '2.4';
        const fakeDomain = '@myapp.com';

        const firebaseConfig = {
          apiKey: "AIzaSyDC_sR04GqMolGCZuBqmshwMn3aP_1qxM8",
          authDomain: "my-pwa-shop-8e911.firebaseapp.com",
          projectId: "my-pwa-shop-8e911",
          storageBucket: "my-pwa-shop-8e911.appspot.com",
          messagingSenderId: "192952139085",
          appId: "1:192952139085:web:cd301112a862ab04d44b04"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let chatUnsubscribe = null;
        let currentOpenChatId = null;

        // --- SECTION 1: INITIALIZATION & VERSIONING ---
        (function() {
            document.querySelector('.version-display').textContent = `v${appVersion}`;
            document.getElementById('css-link').href = `style.css?v=${appVersion}`;
            document.getElementById('manifest-link').href = `manifest.json?v=${appVersion}`;
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register(`./sw.js?v=${appVersion}`).then(reg => console.log('SW Registered')).catch(err => console.log('SW Error'));
                });
            }
        })();

        // --- SECTION 2: GET ELEMENT REFERENCES ---
        const contentSections = document.querySelectorAll('.content-section');
        const navItems = document.querySelectorAll('.nav-item');
        const loginForm = document.getElementById('login-form');
        const userView = document.getElementById('user-view');
        const adminPanel = document.getElementById('admin-panel');
        const categoryGridView = document.getElementById('category-grid-view');
        const productListView = document.getElementById('product-list-view');
        const productListTitle = document.getElementById('product-list-title');
        const backToCategoriesButton = document.getElementById('back-to-categories');
        const categoryCards = document.querySelectorAll('.category-card');
        const tabButtons = document.querySelectorAll('.tab-button');
        const userChatView = document.getElementById('user-chat-view');
        const adminChatView = document.getElementById('admin-chat-view');
        const userChatMessages = document.getElementById('user-chat-messages');
        const adminChatMessages = document.getElementById('admin-chat-messages');
        const userChatForm = document.getElementById('user-chat-form');
        const adminChatForm = document.getElementById('admin-chat-form');
        const chatListContainer = document.getElementById('chat-list-container');
        const adminChatHeader = document.getElementById('admin-chat-header');
        const loggedOutChatView = document.getElementById('logged-out-chat-view'); // NEW

        // --- SECTION 3: CORE NAVIGATION LOGIC ---
        navItems.forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const targetPage = item.getAttribute('data-page');
                history.pushState({ page: targetPage }, '', `#${targetPage}`);
                navItems.forEach(nav => nav.classList.remove('active'));
                item.classList.add('active');
                contentSections.forEach(section => {
                    section.classList.toggle('active', section.id === targetPage);
                });
            });
        });
        
        function showCategories() {
            productListView.style.display = 'none';
            categoryGridView.style.display = 'block';
        }

        function showProducts(categoryName) {
            productListTitle.textContent = categoryName;
            categoryGridView.style.display = 'none';
            productListView.style.display = 'block';
        }

        categoryCards.forEach(card => {
            card.addEventListener('click', (e) => {
                e.preventDefault();
                const categoryName = card.dataset.category;
                history.pushState({ page: 'products', category: categoryName }, categoryName, '#products');
                showProducts(categoryName);
            });
        });
        
        backToCategoriesButton.addEventListener('click', () => {
            history.back();
        });

        window.addEventListener('popstate', (event) => {
            if (event.state) {
                if (event.state.page === 'products') {
                    showProducts(event.state.category);
                } else {
                    document.querySelector(`.nav-item[data-page="${event.state.page}"]`)?.click();
                    showCategories();
                }
            } else {
                document.querySelector('.nav-item[data-page="shop"]')?.click();
                showCategories();
            }
        });

        // --- SECTION 4: OTHER EVENT LISTENERS ---
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const targetTab = button.dataset.tab;
                button.parentElement.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                button.closest('.tabs-container').querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                button.classList.add('active');
                document.getElementById(targetTab).classList.add('active');
            });
        });

        const logoutButton = document.getElementById('logout-button');
        const createUserForm = document.getElementById('create-user-form');
        
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const phoneNumber = loginForm.mobile.value;
            const password = loginForm.password.value;
            const email = phoneNumber.includes('@') ? phoneNumber : phoneNumber + fakeDomain;
            auth.signInWithEmailAndPassword(email, password).catch(error => alert(`خطا در ورود: ${error.message}`));
        });

        logoutButton.addEventListener('click', () => {
            auth.signOut();
        });

        createUserForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const phoneNumber = createUserForm['new-mobile'].value;
            alert(`آماده برای ایجاد کاربر با شماره: ${phoneNumber}. قابلیت اصلی در مرحله بعد اضافه خواهد شد.`);
            createUserForm.reset();
        });
        
        userChatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const input = userChatForm.querySelector('input');
            const text = input.value.trim();
            if (!text || !auth.currentUser) return;
            db.collection('chats').add({
                chatId: auth.currentUser.uid,
                senderId: auth.currentUser.uid,
                text: text,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            input.value = '';
        });

        adminChatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const input = adminChatForm.querySelector('input');
            const text = input.value.trim();
            if (!text || !currentOpenChatId) return;
            db.collection('chats').add({
                chatId: currentOpenChatId,
                senderId: 'admin',
                text: text,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            input.value = '';
        });

        // --- SECTION 5: FIREBASE AUTH & CHAT SETUP LOGIC ---
        auth.onAuthStateChanged(user => {
            const userEmailDisplay = document.getElementById('user-email');
            const loginView = document.getElementById('login-view');
            const adminPanel = document.getElementById('admin-panel');
            
            // Default state for all conditional views
            userView.style.display = 'none';
            adminPanel.style.display = 'none';
            loginView.style.display = 'block';
            userChatView.style.display = 'none';
            adminChatView.style.display = 'none';
            loggedOutChatView.style.display = 'block'; // Show placeholder by default

            if (chatUnsubscribe) {
                chatUnsubscribe();
                chatUnsubscribe = null;
            }

            if (user) {
                // User is LOGGED IN
                loginView.style.display = 'none';
                userView.style.display = 'block';
                loggedOutChatView.style.display = 'none'; // Hide placeholder
                userEmailDisplay.textContent = `خوش آمدید، ${user.email.replace(fakeDomain, '')}`;

                const userDocRef = db.collection('users').doc(user.uid);
                userDocRef.get().then((doc) => {
                    if (doc.exists && doc.data().role === 'admin') {
                        adminPanel.style.display = 'block';
                        setupChatForAdmin();
                    } else {
                        setupChatForUser(user);
                    }
                });
            } else {
                // User is LOGGED OUT
                // The default state we set above is already correct.
                console.log("No user is signed in. Showing chat placeholder.");
            }
        });

        // --- SECTION 6: NEW CHAT HELPER FUNCTIONS ---
        function renderMessages(messages, container, currentUserId) {
            container.innerHTML = '';
            messages.sort((a, b) => (a.timestamp ? a.timestamp.toMillis() : 0) - (b.timestamp ? b.timestamp.toMillis() : 0));
            messages.forEach(msg => {
                const messageEl = document.createElement('div');
                messageEl.classList.add('message');
                messageEl.textContent = msg.text;
                if (msg.senderId === currentUserId || (currentUserId === 'admin' && msg.senderId === 'admin')) {
                    messageEl.classList.add('sent');
                } else {
                    messageEl.classList.add('received');
                }
                container.appendChild(messageEl);
            });
            container.scrollTop = container.scrollHeight;
        }

        function setupChatForUser(user) {
            userChatView.style.display = 'block';
            adminChatView.style.display = 'none';
            const query = db.collection('chats').where('chatId', '==', user.uid);
            chatUnsubscribe = query.onSnapshot(snapshot => {
                const messages = snapshot.docs.map(doc => doc.data());
                renderMessages(messages, userChatMessages, user.uid);
            });
        }

        function openAdminChatForUser(userId, userName) {
            currentOpenChatId = userId;
            adminChatHeader.textContent = `چت با ${userName}`;
            adminChatForm.style.display = 'flex';
            if (chatUnsubscribe) chatUnsubscribe();
            const query = db.collection('chats').where('chatId', '==', userId);
            chatUnsubscribe = query.onSnapshot(snapshot => {
                const messages = snapshot.docs.map(doc => doc.data());
                renderMessages(messages, adminChatMessages, 'admin');
            });
        }
        
        async function setupChatForAdmin() {
            userChatView.style.display = 'none';
            adminChatView.style.display = 'block';
            const chatsSnapshot = await db.collection('chats').orderBy('timestamp', 'desc').get();
            const userIdsWithChats = [...new Set(chatsSnapshot.docs.map(doc => doc.data().chatId))];
            chatListContainer.innerHTML = '';
            
            // In a real app, you would fetch user phone numbers from a 'users' collection.
            // For now, we use the UID as a placeholder.
            userIdsWithChats.forEach(userId => {
                const listItem = document.createElement('div');
                listItem.classList.add('chat-list-item');
                const userName = userId.replace(fakeDomain, ''); // Clean up the UID
                listItem.textContent = `کاربر ${userName}`;
                listItem.onclick = () => openAdminChatForUser(userId, userName);
                chatListContainer.appendChild(listItem);
            });
        }
    </script>
</body>
</html>